# ğŸ“ SoraWatermarkCleaner í”„ë¡œì íŠ¸ ì™„ë²½ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [í”„ë¡œì íŠ¸ê°€ í•˜ëŠ” ì¼](#1-í”„ë¡œì íŠ¸ê°€-í•˜ëŠ”-ì¼)
2. [ì „ì²´ êµ¬ì¡°](#2-ì „ì²´-êµ¬ì¡°)
3. [í•µì‹¬ íŒŒì¼ ìƒì„¸ ì„¤ëª…](#3-í•µì‹¬-íŒŒì¼-ìƒì„¸-ì„¤ëª…)
4. [ì‘ë™ ì›ë¦¬](#4-ì‘ë™-ì›ë¦¬)
5. [ì½”ë“œ íë¦„ ë”°ë¼ê°€ê¸°](#5-ì½”ë“œ-íë¦„-ë”°ë¼ê°€ê¸°)
6. [í•µì‹¬ ê°œë… ì •ë¦¬](#6-í•µì‹¬-ê°œë…-ì •ë¦¬)
7. [ì„¤ê³„ ì² í•™](#7-ì„¤ê³„-ì² í•™)
8. [ì‹¤ì „ ì˜ˆì œ](#8-ì‹¤ì „-ì˜ˆì œ)

---

## 1. í”„ë¡œì íŠ¸ê°€ í•˜ëŠ” ì¼

**í•œ ë¬¸ì¥ ìš”ì•½**: Sora AIê°€ ìƒì„±í•œ ë¹„ë””ì˜¤ì—ì„œ ì›Œí„°ë§ˆí¬(ë¡œê³ )ë¥¼ ìë™ìœ¼ë¡œ ì°¾ì•„ì„œ ê¹”ë”í•˜ê²Œ ì§€ì›Œì£¼ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.

**2ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤**:
```
ì›ë³¸ ë¹„ë””ì˜¤ â†’ [1. ì›Œí„°ë§ˆí¬ ì°¾ê¸°] â†’ [2. ì›Œí„°ë§ˆí¬ ì§€ìš°ê¸°] â†’ ê¹¨ë—í•œ ë¹„ë””ì˜¤
```

---

## 2. ì „ì²´ êµ¬ì¡°

í”„ë¡œì íŠ¸ëŠ” í¬ê²Œ **3ê°œì˜ ë ˆì´ì–´**ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ë ˆì´ì–´        â”‚
â”‚   - example.py (ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸)     â”‚
â”‚   - app.py (ì›¹ ì¸í„°í˜ì´ìŠ¤)          â”‚
â”‚   - start_server.py (API ì„œë²„)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë ˆì´ì–´      â”‚
â”‚   - core.py (ì´ê´„ ê´€ë¦¬ì)           â”‚
â”‚   - watermark_detector.py (íƒì§€)   â”‚
â”‚   - watermark_cleaner.py (ì œê±°)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ìœ í‹¸ë¦¬í‹° & ì„¤ì • ë ˆì´ì–´         â”‚
â”‚   - configs.py (ì„¤ì •)               â”‚
â”‚   - utils/ (ë„ìš°ë¯¸ í•¨ìˆ˜ë“¤)          â”‚
â”‚   - iopaint/ (ì´ë¯¸ì§€ ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. í•µì‹¬ íŒŒì¼ ìƒì„¸ ì„¤ëª…

### ğŸ“„ `configs.py` - ì„¤ì • íŒŒì¼
**ì—­í• **: í”„ë¡œì íŠ¸ ì „ì²´ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ë¡œì™€ ì„¤ì •ê°’ë“¤ì„ í•œ ê³³ì— ëª¨ì•„ë‘ 

```python
# 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì°¾ê¸°
ROOT = Path(__file__).parent.parent
# __file__ì€ í˜„ì¬ íŒŒì¼ ê²½ë¡œ, parentëŠ” ìƒìœ„ í´ë”
# sorawm/configs.py â†’ sorawm/ â†’ SoraWatermarkCleaner/

# 2. ì¤‘ìš”í•œ ë””ë ‰í† ë¦¬ ì •ì˜
RESOURCES_DIR = ROOT / "resources"  # ëª¨ë¸ íŒŒì¼ ì €ì¥ ìœ„ì¹˜
OUTPUT_DIR = ROOT / "output"        # ê²°ê³¼ë¬¼ ì €ì¥ ìœ„ì¹˜

# 3. YOLO ëª¨ë¸ ê²½ë¡œ
WATER_MARK_DETECT_YOLO_WEIGHTS = RESOURCES_DIR / "best.pt"
# best.pt = ì›Œí„°ë§ˆí¬ë¥¼ ì°¾ëŠ” AI ëª¨ë¸ íŒŒì¼

# 4. ê¸°ë³¸ ì›Œí„°ë§ˆí¬ ì œê±° ëª¨ë¸
DEFAULT_WATERMARK_REMOVE_MODEL = "lama"
# LAMA = ì´ë¯¸ì§€ì—ì„œ ë¶ˆí•„ìš”í•œ ë¶€ë¶„ì„ ì§€ìš°ëŠ” AI ëª¨ë¸
```

**ì‰¬ìš´ ë¹„ìœ **:
- ì§‘ì„ ì§“ê¸° ì „ì— ì„¤ê³„ë„ë¥¼ ê·¸ë¦¬ëŠ” ê²ƒì²˜ëŸ¼, í”„ë¡œê·¸ë¨ì´ ì‚¬ìš©í•  ëª¨ë“  ìœ„ì¹˜ì™€ ì„¤ì •ì„ ë¯¸ë¦¬ ì •í•´ë‘ëŠ” íŒŒì¼ì…ë‹ˆë‹¤.

---

### ğŸ“„ `watermark_detector.py` - ì›Œí„°ë§ˆí¬ íƒì§€ê¸°
**ì—­í• **: ë¹„ë””ì˜¤ì˜ ê° í”„ë ˆì„(ì‚¬ì§„)ì—ì„œ ì›Œí„°ë§ˆí¬ê°€ ì–´ë”” ìˆëŠ”ì§€ ì°¾ì•„ëƒ„

```python
class SoraWaterMarkDetector:
    def __init__(self):
        # 1. ëª¨ë¸ì´ ì—†ìœ¼ë©´ ë‹¤ìš´ë¡œë“œ
        download_detector_weights()

        # 2. YOLO ëª¨ë¸ ë¡œë“œ (ë¬¼ì²´ ì¸ì‹ AI)
        self.model = YOLO(WATER_MARK_DETECT_YOLO_WEIGHTS)

        # 3. GPU/CPU ì„ íƒ
        self.model.to(str(get_device()))
```

**í•µì‹¬ ë©”ì„œë“œ**: `detect(input_image)`

```python
def detect(self, input_image: np.array):
    # 1. YOLO ëª¨ë¸ì— ì´ë¯¸ì§€ë¥¼ ë„£ì–´ì„œ ë¶„ì„
    results = self.model(input_image, verbose=False)

    # 2. ì›Œí„°ë§ˆí¬ë¥¼ ì°¾ì•˜ëŠ”ì§€ í™•ì¸
    if len(result.boxes) == 0:
        return {"detected": False, ...}  # ëª» ì°¾ìŒ

    # 3. ì›Œí„°ë§ˆí¬ ìœ„ì¹˜ ì¶”ì¶œ (x1, y1, x2, y2)
    # x1, y1 = ì™¼ìª½ ìœ„ ëª¨ì„œë¦¬
    # x2, y2 = ì˜¤ë¥¸ìª½ ì•„ë˜ ëª¨ì„œë¦¬
    bbox = (int(x1), int(y1), int(x2), int(y2))

    # 4. ê²°ê³¼ ë°˜í™˜
    return {
        "detected": True,
        "bbox": bbox,           # ì›Œí„°ë§ˆí¬ ìœ„ì¹˜
        "confidence": 0.95,     # í™•ì‹ ë„ (95%)
        "center": (cx, cy)      # ì¤‘ì‹¬ì 
    }
```

**ì‰¬ìš´ ë¹„ìœ **:
- ì‚¬ì§„ ì†ì—ì„œ "ì›”ë¦¬ë¥¼ ì°¾ì•„ë¼" í•˜ëŠ” ê²ƒì²˜ëŸ¼, AIê°€ ì›Œí„°ë§ˆí¬ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
- ì°¾ìœ¼ë©´ "ì—¬ê¸° ìˆì–´ìš”! (x, y ì¢Œí‘œ)"ë¼ê³  ì•Œë ¤ì¤ë‹ˆë‹¤.

**YOLOë€?**
- "You Only Look Once"ì˜ ì•½ì
- ì´ë¯¸ì§€ì—ì„œ ë¬¼ì²´ë¥¼ ë§¤ìš° ë¹ ë¥´ê²Œ ì°¾ëŠ” ìœ ëª…í•œ AI ëª¨ë¸
- ì—¬ê¸°ì„œëŠ” "ì›Œí„°ë§ˆí¬"ë¥¼ ì°¾ë„ë¡ í›ˆë ¨ë˜ì—ˆìŠµë‹ˆë‹¤

---

### ğŸ“„ `watermark_cleaner.py` - ì›Œí„°ë§ˆí¬ ì œê±°ê¸°
**ì—­í• **: ì›Œí„°ë§ˆí¬ê°€ ìˆëŠ” ìœ„ì¹˜ë¥¼ ë°›ì•„ì„œ ê·¸ ë¶€ë¶„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì§€ì›Œëƒ„

```python
class WaterMarkCleaner:
    def __init__(self):
        # 1. LAMA ëª¨ë¸ í™•ì¸ ë° ë‹¤ìš´ë¡œë“œ
        scanned_models = scan_models()
        if "lama" not in scanned_models:
            cli_download_model("lama")

        # 2. ëª¨ë¸ ë§¤ë‹ˆì € ì´ˆê¸°í™”
        self.model_manager = ModelManager(
            name="lama",
            device=self.device
        )
```

**í•µì‹¬ ë©”ì„œë“œ**: `clean(input_image, watermark_mask)`

```python
def clean(self, input_image: np.array, watermark_mask: np.array):
    # 1. ëª¨ë¸ì— ì´ë¯¸ì§€ì™€ ë§ˆìŠ¤í¬ ì „ë‹¬
    # input_image = ì›ë³¸ ì´ë¯¸ì§€
    # watermark_mask = ì›Œí„°ë§ˆí¬ ìœ„ì¹˜ í‘œì‹œ (í°ìƒ‰ = ì§€ìš¸ ë¶€ë¶„)

    inpaint_result = self.model_manager(
        input_image,
        watermark_mask,
        self.inpaint_request
    )

    # 2. ìƒ‰ìƒ ë³€í™˜ (BGR â†’ RGB)
    inpaint_result = cv2.cvtColor(inpaint_result, cv2.COLOR_BGR2RGB)

    return inpaint_result  # ê¹¨ë—í•´ì§„ ì´ë¯¸ì§€
```

**ì‰¬ìš´ ë¹„ìœ **:
- í¬í† ìƒµì˜ "ìŠ¤íŒŸ íë§ ë¸ŒëŸ¬ì‹œ" ê°™ì€ ê¸°ëŠ¥
- ì›Œí„°ë§ˆí¬ê°€ ìˆë˜ ìë¦¬ë¥¼ ì£¼ë³€ í”½ì…€ì„ ì°¸ê³ í•´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì±„ì›Œ ë„£ìŠµë‹ˆë‹¤

**LAMAë€?**
- "Large Mask Inpainting"ì˜ ì•½ì
- ì´ë¯¸ì§€ì—ì„œ í° ì˜ì—­ì„ ì§€ìš°ê³  ìì—°ìŠ¤ëŸ½ê²Œ ë³µì›í•˜ëŠ” AI ëª¨ë¸
- ì£¼ë³€ íŒ¨í„´ì„ í•™ìŠµí•´ì„œ ë¹ˆ ê³µê°„ì„ ì±„ì›ë‹ˆë‹¤

---

### ğŸ“„ `core.py` - ì´ê´„ ê´€ë¦¬ì (ê°€ì¥ ì¤‘ìš”!)
**ì—­í• **: íƒì§€ê¸°ì™€ ì œê±°ê¸°ë¥¼ ì¡°í•©í•´ì„œ ì „ì²´ ë¹„ë””ì˜¤ ì²˜ë¦¬ë¥¼ ê´€ë¦¬

```python
class SoraWM:
    def __init__(self):
        # íƒì§€ê¸°ì™€ ì œê±°ê¸° ì´ˆê¸°í™”
        self.detector = SoraWaterMarkDetector()  # ì›Œí„°ë§ˆí¬ ì°¾ê¸°
        self.cleaner = WaterMarkCleaner()        # ì›Œí„°ë§ˆí¬ ì§€ìš°ê¸°
```

**í•µì‹¬ ë©”ì„œë“œ**: `run(input_video_path, output_video_path)`

ì´ ë©”ì„œë“œëŠ” **4ë‹¨ê³„**ë¡œ ì‘ë™í•©ë‹ˆë‹¤:

#### **1ë‹¨ê³„: ë¹„ë””ì˜¤ ë¡œë”© ë° ì„¤ì •**

```python
# ë¹„ë””ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
input_video_loader = VideoLoader(input_video_path)
width = input_video_loader.width      # ê°€ë¡œ í¬ê¸°
height = input_video_loader.height    # ì„¸ë¡œ í¬ê¸°
fps = input_video_loader.fps          # ì´ˆë‹¹ í”„ë ˆì„ ìˆ˜
total_frames = input_video_loader.total_frames  # ì´ í”„ë ˆì„ ìˆ˜

# ì¶œë ¥ ë¹„ë””ì˜¤ ì„¤ì •
output_options = {
    "pix_fmt": "yuv420p",     # í”½ì…€ í¬ë§·
    "vcodec": "libx264",      # ë¹„ë””ì˜¤ ì½”ë± (ì••ì¶• ë°©ì‹)
    "preset": "slow",         # í’ˆì§ˆ ìš°ì„ 
}
```

**ì‰¬ìš´ ë¹„ìœ **:
- ì˜í™”ê´€ì—ì„œ ì˜í™”ë¥¼ ì¬ìƒí•˜ê¸° ì „ì—, í•„ë¦„ì˜ í¬ê¸°ì™€ ì¬ìƒ ì†ë„ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.

#### **2ë‹¨ê³„: ëª¨ë“  í”„ë ˆì„ì—ì„œ ì›Œí„°ë§ˆí¬ íƒì§€**

```python
frame_bboxes = {}      # ê° í”„ë ˆì„ì˜ ì›Œí„°ë§ˆí¬ ìœ„ì¹˜ ì €ì¥
detect_missed = []     # ì›Œí„°ë§ˆí¬ë¥¼ ëª» ì°¾ì€ í”„ë ˆì„ ë²ˆí˜¸
bbox_centers = []      # ì›Œí„°ë§ˆí¬ ì¤‘ì‹¬ì ë“¤
bboxes = []           # ì›Œí„°ë§ˆí¬ ë°•ìŠ¤ë“¤

# ëª¨ë“  í”„ë ˆì„ ìˆœíšŒ
for idx, frame in enumerate(tqdm(..., desc="Detect watermarks")):
    # í˜„ì¬ í”„ë ˆì„ì—ì„œ ì›Œí„°ë§ˆí¬ ì°¾ê¸°
    detection_result = self.detector.detect(frame)

    if detection_result["detected"]:
        # ì°¾ì•˜ìœ¼ë©´ ì €ì¥
        frame_bboxes[idx] = {"bbox": detection_result["bbox"]}
        bbox_centers.append((cx, cy))
    else:
        # ëª» ì°¾ì•˜ìœ¼ë©´ ë‚˜ì¤‘ì— ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ê¸°ë¡
        detect_missed.append(idx)
        bbox_centers.append(None)
```

**ì™œ ëª» ì°¾ëŠ” í”„ë ˆì„ì´ ìˆì„ê¹Œ?**
- ì›Œí„°ë§ˆí¬ê°€ ë„ˆë¬´ íë¦¿í•œ ê²½ìš°
- ì¹´ë©”ë¼ê°€ ë¹ ë¥´ê²Œ ì›€ì§ì—¬ì„œ ë¸”ëŸ¬ëœ ê²½ìš°
- ì›Œí„°ë§ˆí¬ê°€ ì¼ì‹œì ìœ¼ë¡œ ê°€ë ¤ì§„ ê²½ìš°

**ëª» ì°¾ì€ í”„ë ˆì„ ì²˜ë¦¬**:

```python
if detect_missed:
    # 1. ì›Œí„°ë§ˆí¬ ìœ„ì¹˜ ë³€í™”ì˜ "ë³€ê³¡ì " ì°¾ê¸°
    bkps = find_2d_data_bkps(bbox_centers)
    # ì˜ˆ: í”„ë ˆì„ 0~100ì€ ì™¼ìª½ ìœ„, 101~200ì€ ì˜¤ë¥¸ìª½ ì•„ë˜

    # 2. ê° êµ¬ê°„ì˜ í‰ê·  ìœ„ì¹˜ ê³„ì‚°
    interval_bboxes = get_interval_average_bbox(bboxes, bkps_full)

    # 3. ëª» ì°¾ì€ í”„ë ˆì„ì— í‰ê· ê°’ ì±„ìš°ê¸°
    for missed_idx, interval_idx in zip(detect_missed, missed_intervals):
        frame_bboxes[missed_idx]["bbox"] = interval_bboxes[interval_idx]
```

**ì‰¬ìš´ ë¹„ìœ **:
- ë¹„ë””ì˜¤ë¥¼ ë³´ë‹¤ê°€ ì¼ë¶€ í”„ë ˆì„ì´ ê¹œë¹¡ì—¬ì„œ ì•ˆ ë³´ì´ë©´, ì•ë’¤ í”„ë ˆì„ì„ ë³´ê³  ì¶”ì¸¡í•˜ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.
- "ì•„, í”„ë ˆì„ 50ì—ì„œëŠ” ì›Œí„°ë§ˆí¬ê°€ ì™¼ìª½ ìœ„ì— ìˆì—ˆê³ , í”„ë ˆì„ 52ì—ì„œë„ ì™¼ìª½ ìœ„ì— ìˆì—ˆìœ¼ë‹ˆ, í”„ë ˆì„ 51ë„ ê°™ì€ ìœ„ì¹˜ì— ìˆì—ˆì„ ê±°ì•¼"

#### **3ë‹¨ê³„: ëª¨ë“  í”„ë ˆì„ì—ì„œ ì›Œí„°ë§ˆí¬ ì œê±°**

```python
# ë¹„ë””ì˜¤ë¥¼ ë‹¤ì‹œ ì²˜ìŒë¶€í„° ì½ê¸°
input_video_loader = VideoLoader(input_video_path)

for idx, frame in enumerate(tqdm(..., desc="Remove watermarks")):
    # 1. ì´ í”„ë ˆì„ì˜ ì›Œí„°ë§ˆí¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    bbox = frame_bboxes[idx]["bbox"]

    if bbox is not None:
        # 2. ë§ˆìŠ¤í¬ ë§Œë“¤ê¸° (ì›Œí„°ë§ˆí¬ ë¶€ë¶„ë§Œ í°ìƒ‰)
        x1, y1, x2, y2 = bbox
        mask = np.zeros((height, width), dtype=np.uint8)
        mask[y1:y2, x1:x2] = 255  # ì›Œí„°ë§ˆí¬ ì˜ì—­ë§Œ 255(í°ìƒ‰)

        # 3. í´ë¦¬ë„ˆë¡œ ì›Œí„°ë§ˆí¬ ì œê±°
        cleaned_frame = self.cleaner.clean(frame, mask)
    else:
        # ì›Œí„°ë§ˆí¬ê°€ ì—†ìœ¼ë©´ ì›ë³¸ ê·¸ëŒ€ë¡œ
        cleaned_frame = frame

    # 4. ì²˜ë¦¬ëœ í”„ë ˆì„ì„ ì¶œë ¥ ë¹„ë””ì˜¤ì— ì“°ê¸°
    process_out.stdin.write(cleaned_frame.tobytes())
```

**ë§ˆìŠ¤í¬(Mask)ë€?**
```
ì›ë³¸ ì´ë¯¸ì§€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚
â”‚   [SORA]    â”‚  â† ì›Œí„°ë§ˆí¬
â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ë§ˆìŠ¤í¬ (í°ìƒ‰ = ì§€ìš¸ ë¶€ë¶„):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 000000000000â”‚
â”‚ 0 [â– â– â– â– ] 0 â”‚  â† í°ìƒ‰ ë¶€ë¶„ (255)
â”‚ 000000000000â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ê²°ê³¼:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚
â”‚    (ê¹¨ë—)   â”‚  â† ì›Œí„°ë§ˆí¬ ì œê±°ë¨
â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **4ë‹¨ê³„: ì˜¤ë””ì˜¤ í•©ì¹˜ê¸°**

```python
def merge_audio_track(self, input_video_path, temp_output_path, output_video_path):
    # 1. ì„ì‹œ ë¹„ë””ì˜¤ (ë¹„ì£¼ì–¼ë§Œ)
    video_stream = ffmpeg.input(str(temp_output_path))

    # 2. ì›ë³¸ ë¹„ë””ì˜¤ì˜ ì˜¤ë””ì˜¤
    audio_stream = ffmpeg.input(str(input_video_path)).audio

    # 3. ë¹„ë””ì˜¤ + ì˜¤ë””ì˜¤ í•©ì¹˜ê¸°
    ffmpeg.output(
        video_stream,
        audio_stream,
        str(output_video_path),
        vcodec="copy",   # ë¹„ë””ì˜¤ëŠ” ê·¸ëŒ€ë¡œ ë³µì‚¬
        acodec="aac",    # ì˜¤ë””ì˜¤ëŠ” AACë¡œ ì¸ì½”ë”©
    ).run()

    # 4. ì„ì‹œ íŒŒì¼ ì‚­ì œ
    temp_output_path.unlink()
```

**ì™œ ì˜¤ë””ì˜¤ë¥¼ ë”°ë¡œ ì²˜ë¦¬í• ê¹Œ?**
- ì›Œí„°ë§ˆí¬ ì œê±° ê³¼ì •ì—ì„œëŠ” ë¹„ì£¼ì–¼(ì˜ìƒ)ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤
- ì˜¤ë””ì˜¤ëŠ” ê±´ë“œë¦´ í•„ìš”ê°€ ì—†ìœ¼ë‹ˆ, ì›ë³¸ì—ì„œ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤
- ë§ˆì§€ë§‰ì— ê¹¨ë—í•œ ì˜ìƒ + ì›ë³¸ ì˜¤ë””ì˜¤ë¥¼ í•©ì¹©ë‹ˆë‹¤

---

## 4. ì‘ë™ ì›ë¦¬

### ì „ì²´ íŒŒì´í”„ë¼ì¸

```
ì…ë ¥: download.mp4 (300 í”„ë ˆì„, 30fps, 704x1280)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ë‹¨ê³„: ë¹„ë””ì˜¤ ë¶„ì„                     â”‚
â”‚  - ë¹„ë””ì˜¤ ì •ë³´ ì½ê¸° (í¬ê¸°, fps ë“±)      â”‚
â”‚  - ì¶œë ¥ ì„¤ì • ì¤€ë¹„                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ë‹¨ê³„: ì›Œí„°ë§ˆí¬ íƒì§€ (12ì´ˆ ì†Œìš”)       â”‚
â”‚  í”„ë ˆì„ 1/300: [SORA] ë°œê²¬! (50, 55)   â”‚
â”‚  í”„ë ˆì„ 2/300: [SORA] ë°œê²¬! (51, 56)   â”‚
â”‚  í”„ë ˆì„ 3/300: ëª» ì°¾ìŒ âŒ               â”‚
â”‚  ...                                    â”‚
â”‚  ê²°ê³¼: 296ê°œ ì°¾ìŒ, 4ê°œ ëª» ì°¾ìŒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2.5ë‹¨ê³„: ëª» ì°¾ì€ í”„ë ˆì„ ë³´ê°„            â”‚
â”‚  - ì•ë’¤ í”„ë ˆì„ ì°¸ê³ í•´ì„œ ìœ„ì¹˜ ì¶”ì •       â”‚
â”‚  - ëª¨ë“  í”„ë ˆì„ì— ì›Œí„°ë§ˆí¬ ìœ„ì¹˜ í™•ì •     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ë‹¨ê³„: ì›Œí„°ë§ˆí¬ ì œê±° (2ë¶„ 10ì´ˆ ì†Œìš”)   â”‚
â”‚  í”„ë ˆì„ 1/300: ë§ˆìŠ¤í¬ ìƒì„± â†’ LAMA ì²˜ë¦¬  â”‚
â”‚  í”„ë ˆì„ 2/300: ë§ˆìŠ¤í¬ ìƒì„± â†’ LAMA ì²˜ë¦¬  â”‚
â”‚  ...                                    â”‚
â”‚  â†’ temp_download_cleaned.mp4 ìƒì„±       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ë‹¨ê³„: ì˜¤ë””ì˜¤ ë³‘í•©                     â”‚
â”‚  temp ë¹„ë””ì˜¤ + ì›ë³¸ ì˜¤ë””ì˜¤              â”‚
â”‚  â†’ download_cleaned.mp4                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
ì¶œë ¥: download_cleaned.mp4 (ì›Œí„°ë§ˆí¬ ì œê±° ì™„ë£Œ!)
```

---

## 5. ì½”ë“œ íë¦„ ë”°ë¼ê°€ê¸°

ì‹¤ì œë¡œ `example.py`ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ì§€ ë”°ë¼ê°€ ë´…ì‹œë‹¤:

### Step 1: í”„ë¡œê·¸ë¨ ì‹œì‘

```python
# example.py
from sorawm.core import SoraWM

input_video = Path("inputs/download.mp4")
output_video = Path("outputs/download_cleaned.mp4")

sora_wm = SoraWM()  # â† ì—¬ê¸°ì„œ ì‹œì‘!
```

**ë‚´ë¶€ì—ì„œ ì¼ì–´ë‚˜ëŠ” ì¼**:

```python
# core.pyì˜ __init__
def __init__(self):
    # 1. íƒì§€ê¸° ì´ˆê¸°í™”
    self.detector = SoraWaterMarkDetector()
        # â†’ watermark_detector.pyë¡œ ì´ë™
        # â†’ YOLO ëª¨ë¸ ë¡œë“œ (best.pt)
        # â†’ GPU/MPS ì„ íƒ

    # 2. ì œê±°ê¸° ì´ˆê¸°í™”
    self.cleaner = WaterMarkCleaner()
        # â†’ watermark_cleaner.pyë¡œ ì´ë™
        # â†’ LAMA ëª¨ë¸ í™•ì¸/ë‹¤ìš´ë¡œë“œ
        # â†’ ModelManager ì´ˆê¸°í™”
```

### Step 2: ë¹„ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘

```python
sora_wm.run(input_video, output_video)
```

**ë‚´ë¶€ íë¦„**:

```python
# core.pyì˜ run()
def run(self, input_video_path, output_video_path):
    # === ë¹„ë””ì˜¤ ë¡œë”© ===
    video_loader = VideoLoader(input_video_path)
    # ë¹„ë””ì˜¤ íŒŒì¼ ì—´ê¸°, ì •ë³´ ì½ê¸°

    width = 704
    height = 1280
    fps = 30.0
    total_frames = 300

    # === FFmpeg ì¶œë ¥ íŒŒì´í”„ ì„¤ì • ===
    process_out = ffmpeg.input("pipe:", ...).output(...)
    # í”„ë ˆì„ì„ í•˜ë‚˜ì”© ë°›ì•„ì„œ ë¹„ë””ì˜¤ë¡œ ë§Œë“¤ ì¤€ë¹„
```

### Step 3: íƒì§€ ë£¨í”„

```python
# ê° í”„ë ˆì„ ì²˜ë¦¬
for idx, frame in enumerate(video_loader):
    # frame = 704x1280 í¬ê¸°ì˜ ì´ë¯¸ì§€ (numpy ë°°ì—´)

    # ì›Œí„°ë§ˆí¬ íƒì§€
    detection = self.detector.detect(frame)
    # â†’ watermark_detector.pyì˜ detect() í˜¸ì¶œ

    if detection["detected"]:
        # ì˜ˆ: {"detected": True, "bbox": (50, 55, 229, 132)}
        frame_bboxes[idx] = {"bbox": (50, 55, 229, 132)}
    else:
        detect_missed.append(idx)
```

**YOLO ëª¨ë¸ ë‚´ë¶€** (ë‹¨ìˆœí™”):

```python
# YOLOê°€ í•˜ëŠ” ì¼
def detect(self, input_image):
    # 1. ì´ë¯¸ì§€ë¥¼ ì‹ ê²½ë§ì— í†µê³¼
    features = neural_network(input_image)

    # 2. ì›Œí„°ë§ˆí¬ ê°™ì€ íŒ¨í„´ ì°¾ê¸°
    boxes = find_objects(features)

    # 3. ê°€ì¥ í™•ì‹¤í•œ ê²ƒ ë°˜í™˜
    if boxes:
        return boxes[0]  # (x1, y1, x2, y2)
```

### Step 4: ì œê±° ë£¨í”„

```python
for idx, frame in enumerate(video_loader):
    bbox = frame_bboxes[idx]["bbox"]  # (50, 55, 229, 132)

    # ë§ˆìŠ¤í¬ ë§Œë“¤ê¸°
    mask = np.zeros((1280, 704), dtype=np.uint8)
    mask[55:132, 50:229] = 255
    # â†’ ì›Œí„°ë§ˆí¬ ì˜ì—­ë§Œ í°ìƒ‰(255), ë‚˜ë¨¸ì§€ëŠ” ê²€ì€ìƒ‰(0)

    # LAMA ëª¨ë¸ë¡œ ì›Œí„°ë§ˆí¬ ì œê±°
    cleaned = self.cleaner.clean(frame, mask)

    # ê²°ê³¼ë¥¼ ë¹„ë””ì˜¤ì— ì“°ê¸°
    process_out.stdin.write(cleaned.tobytes())
```

**LAMA ëª¨ë¸ ë‚´ë¶€** (ë‹¨ìˆœí™”):

```python
def clean(self, image, mask):
    # 1. ë§ˆìŠ¤í¬ê°€ ê°€ë¦¬í‚¤ëŠ” ë¶€ë¶„ í™•ì¸
    watermark_area = image[mask == 255]

    # 2. ì£¼ë³€ í”½ì…€ ë¶„ì„
    surrounding = analyze_neighbors(image, mask)

    # 3. AIë¡œ ë¹ˆ ê³µê°„ ì±„ìš°ê¸°
    filled = neural_network.predict(surrounding)

    # 4. ê²°ê³¼ í•©ì¹˜ê¸°
    image[mask == 255] = filled
    return image
```

### Step 5: ì˜¤ë””ì˜¤ ë³‘í•©

```python
# ì„ì‹œ ë¹„ë””ì˜¤ (temp_download_cleaned.mp4) ìƒì„± ì™„ë£Œ
# ì´ì œ ì˜¤ë””ì˜¤ë¥¼ í•©ì¹œë‹¤

self.merge_audio_track(
    input_video_path,   # ì›ë³¸ (ì˜¤ë””ì˜¤ ìˆìŒ)
    temp_output_path,   # ì„ì‹œ (ë¹„ë””ì˜¤ë§Œ)
    output_video_path   # ìµœì¢… ì¶œë ¥
)

# FFmpeg ëª…ë ¹ì–´ ì‹¤í–‰:
# ffmpeg -i temp.mp4 -i original.mp4 -c:v copy -c:a aac output.mp4
```

---

## 6. í•µì‹¬ ê°œë… ì •ë¦¬

### 1. **í”„ë ˆì„ (Frame)**
- ë¹„ë””ì˜¤ëŠ” ì‚¬ì‹¤ ì—¬ëŸ¬ ì¥ì˜ ì‚¬ì§„ì´ ë¹ ë¥´ê²Œ ì¬ìƒë˜ëŠ” ê²ƒ
- 30fps = 1ì´ˆì— 30ì¥ì˜ ì‚¬ì§„
- ê° ì‚¬ì§„ = 1 í”„ë ˆì„

### 2. **Bounding Box (bbox)**
- ì‚¬ê°í˜• ì˜ì—­ì„ ë‚˜íƒ€ë‚´ëŠ” ì¢Œí‘œ
- `(x1, y1, x2, y2)` = (ì™¼ìª½ ìœ„ x, ì™¼ìª½ ìœ„ y, ì˜¤ë¥¸ìª½ ì•„ë˜ x, ì˜¤ë¥¸ìª½ ì•„ë˜ y)

```
(0,0)
  â†“
  (x1,y1)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   ì›Œí„°ë§ˆí¬   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€(x2,y2)
```

### 3. **ë§ˆìŠ¤í¬ (Mask)**
- ì´ë¯¸ì§€ì—ì„œ "ì´ ë¶€ë¶„ë§Œ ì²˜ë¦¬í•´"ë¼ê³  ì•Œë ¤ì£¼ëŠ” í‘œì‹œ
- 0 (ê²€ì€ìƒ‰) = ê±´ë“œë¦¬ì§€ ë§ˆ
- 255 (í°ìƒ‰) = ì´ ë¶€ë¶„ ì²˜ë¦¬í•´

### 4. **Inpainting (ì¸í˜ì¸íŒ…)**
- ì´ë¯¸ì§€ì˜ ë¹ˆ ê³µê°„ì„ ì±„ìš°ëŠ” ê¸°ìˆ 
- LAMAê°€ í•˜ëŠ” ì¼
- ì£¼ë³€ í”½ì…€ì„ ë³´ê³  ìì—°ìŠ¤ëŸ½ê²Œ ì±„ì›€

### 5. **YOLO (ìšœë¡œ)**
- ì‹¤ì‹œê°„ ê°ì²´ ì¸ì‹ AI
- ì´ë¯¸ì§€ë¥¼ ë³´ê³  "ì—¬ê¸°ì— ë­ê°€ ìˆì–´!"ë¼ê³  ì°¾ì•„ëƒ„
- ì—¬ê¸°ì„œëŠ” ì›Œí„°ë§ˆí¬ë¥¼ ì°¾ë„ë¡ í›ˆë ¨ë¨

---

## 7. ì„¤ê³„ ì² í•™

### ì™œ ì´ë ‡ê²Œ ì„¤ê³„í–ˆì„ê¹Œ?

#### 1. **ì™œ 2ë‹¨ê³„ë¡œ ë‚˜ëˆ´ì„ê¹Œ?** (íƒì§€ â†’ ì œê±°)
- **íš¨ìœ¨ì„±**: íƒì§€ëŠ” ë¹ ë¥´ì§€ë§Œ, ì œê±°ëŠ” ëŠë¦¼
- **ì •í™•ì„±**: ë¨¼ì € ëª¨ë“  ìœ„ì¹˜ë¥¼ íŒŒì•…í•œ í›„, ì¼ê´€ë˜ê²Œ ì²˜ë¦¬
- **ë””ë²„ê¹…**: íƒì§€ë§Œ í…ŒìŠ¤íŠ¸í•˜ê±°ë‚˜, ì œê±°ë§Œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

#### 2. **ì™œ ëª» ì°¾ì€ í”„ë ˆì„ì„ ë³´ê°„í• ê¹Œ?**
- ì¼ë¶€ í”„ë ˆì„ì—ì„œ íƒì§€ ì‹¤íŒ¨ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í˜„ìƒ
- ì•ë’¤ í”„ë ˆì„ ì •ë³´ë¡œ ì¶”ì¸¡í•˜ë©´ ë” ìì—°ìŠ¤ëŸ¬ìš´ ê²°ê³¼

#### 3. **ì™œ ì„ì‹œ íŒŒì¼ì„ ë§Œë“¤ê¹Œ?**
- ë¹„ë””ì˜¤ ì²˜ë¦¬ëŠ” ì˜¤ë””ì˜¤ ì—†ì´ ë¨¼ì € ì§„í–‰
- ì˜¤ë””ì˜¤ëŠ” ë‚˜ì¤‘ì— ì›ë³¸ì—ì„œ ê°€ì ¸ì™€ í•©ì¹¨
- ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì—†ì´ ë¹„ì£¼ì–¼ë§Œ ë¹ ë¥´ê²Œ ì²˜ë¦¬

---

## 8. ì‹¤ì „ ì˜ˆì œ

### ì˜ˆì œ 1: ì›Œí„°ë§ˆí¬ íƒì§€ ê²°ê³¼ ì €ì¥í•˜ê¸°

```python
# core.pyì˜ run() ë©”ì„œë“œ ìˆ˜ì •
for idx, frame in enumerate(tqdm(...)):
    detection = self.detector.detect(frame)

    if detection["detected"]:
        # ì›Œí„°ë§ˆí¬ ìœ„ì¹˜ì— ë¹¨ê°„ ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
        x1, y1, x2, y2 = detection["bbox"]
        cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 0, 255), 2)

        # í”„ë ˆì„ ì €ì¥
        cv2.imwrite(f"debug/frame_{idx}_detected.jpg", frame)
```

### ì˜ˆì œ 2: ì§„í–‰ë¥  ì½œë°± ì‚¬ìš©í•˜ê¸°

```python
# example.py
def print_progress(percent):
    print(f"ì§„í–‰ë¥ : {percent}%")

sora_wm = SoraWM()
sora_wm.run(
    input_video,
    output_video,
    progress_callback=print_progress  # ì½œë°± ì¶”ê°€
)
```

---

## ğŸ“ ìš”ì•½

1. **configs.py**: ì„¤ì • ëª¨ìŒì§‘
2. **watermark_detector.py**: YOLOë¡œ ì›Œí„°ë§ˆí¬ ì°¾ê¸°
3. **watermark_cleaner.py**: LAMAë¡œ ì›Œí„°ë§ˆí¬ ì§€ìš°ê¸°
4. **core.py**: ì „ì²´ ì˜¤ì¼€ìŠ¤íŠ¸ë¼ ì§€íœ˜ì

**ì²˜ë¦¬ ìˆœì„œ**:
```
ë¹„ë””ì˜¤ ë¡œë“œ â†’ ëª¨ë“  í”„ë ˆì„ íƒì§€ â†’ ëª» ì°¾ì€ ê²ƒ ë³´ê°„
â†’ ëª¨ë“  í”„ë ˆì„ ì œê±° â†’ ì˜¤ë””ì˜¤ ë³‘í•© â†’ ì™„ì„±!
```

---

## ğŸ“š ì¶”ê°€ í•™ìŠµ ìë£Œ

- [YOLO ê³µì‹ ë¬¸ì„œ](https://docs.ultralytics.com/)
- [LAMA ë…¼ë¬¸](https://arxiv.org/abs/2109.07161)
- [FFmpeg ê°€ì´ë“œ](https://ffmpeg.org/documentation.html)
- [OpenCV íŠœí† ë¦¬ì–¼](https://docs.opencv.org/4.x/d9/df8/tutorial_root.html)
